{% extends "base.html" %}

{% block content %}
<div class="main-content" style="max-width: 700px; margin: 0 auto;">

    <div class="card dash-card shadow-sm">

        <div class="card-header card-header-purple text-center py-3">
            <h3 class="mb-0">F√∂rh√∂r ‚Äì skriv dina svar</h3>
        </div>

        <div class="card-body">

            <p class="text-muted text-center mb-4">
                Svara p√• alla fr√•gor nedan och skicka in dina svar.
            </p>

            <form id="quiz-form">

                <div class="table-responsive">
                    <table class="table table-bordered align-middle mb-4">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 45%;">Fr√•ga</th>
                                <th style="width: 55%;">Ditt svar</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in quiz_data %}
                            <tr>
                                <td><strong>{{ item.question }}</strong></td>
                                <td>
                                    <input type="text"
                                           name="{{ item.id }}"
                                           class="form-control"
                                           required>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <button type="submit" class="primary-btn w-100 py-2">
                    Skicka svar
                </button>

            </form>

            <!-- RESULTAT -->
            <div id="result-wrapper" style="display:none; margin-top:25px;">

                <h5 class="text-center mb-2">Resultat</h5>

                <div class="quiz-progress-bar-bg" style="height:22px;">
                    <div id="progress-bar"
                         class="quiz-progress-bar"
                         style="height:100%; width:0%;"></div>
                </div>

                <p id="result-text" class="text-center mt-3 mb-0 fw-bold"></p>
            </div>

            <!-- Navigering -->
            <div id="after-buttons" style="display:none;" class="mt-4">
                <a href="{{ url_for('main.home') }}" class="primary-btn w-100 mb-2">
                    Hem
                </a>
                <a href="{{ url_for('main.quiz_settings') }}" class="primary-btn w-100 mb-2">
                    Starta nytt f√∂rh√∂r
                </a>
            </div>

        </div>
    </div>

</div>

<!-- Konfetti -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

{% endblock %}

{% block scripts %}
<script>
document.getElementById('quiz-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const form = e.target;
    const formData = new FormData(form);
    const data = {};

    for (let [key, value] of formData.entries()) {
        data[key] = value;
    }

    const response = await fetch("{{ url_for('main.quiz_take') }}", {
        method: 'POST',
        body: new URLSearchParams(data),
    });

    const result = await response.json();
    const percent = result.percent;

    const resultWrapper = document.getElementById('result-wrapper');
    const text = document.getElementById('result-text');
    const bar = document.getElementById('progress-bar');

    // Visa resultatdelen
    resultWrapper.style.display = 'block';
    document.getElementById('after-buttons').style.display = 'block';

    // Uppdatera progress bar
    bar.style.width = percent + '%';
    bar.textContent = percent + '%';

    text.textContent = `Du fick ${result.correct} av ${result.total} r√§tt (${percent}%)`;

    // üéâ Konfetti om 100%
    if (percent === 100) {
        const duration = 2000;
        const end = Date.now() + duration;

        (function frame() {
            confetti({
                particleCount: 8,
                angle: 60,
                spread: 70,
                origin: { x: 0 }
            });
            confetti({
                particleCount: 8,
                angle: 120,
                spread: 70,
                origin: { x: 1 }
            });

            if (Date.now() < end) {
                requestAnimationFrame(frame);
            }
        })();
    }
});
</script>
{% endblock %}
