{% extends "base.html" %}

{% block title %}Förhör{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/quiz.css') }}">
{% endblock %}

{% block content %}
<div class="quiz-page">

    <!-- QUIZ HERO -->
    <div class="quiz-hero">
        <div class="quiz-hero-overlay"></div>
        <h1 class="quiz-hero-title">Förhör</h1>
        <p class="quiz-hero-sub">{{ quiz_data|length }} ord</p>
    </div>

    <!-- HEADER + PROGRESS -->
    <div class="quiz-header">
        <p class="quiz-level-label">Personligt förhör</p>

        <div class="quiz-progress-wrapper">
            <div class="quiz-progress-bar">
                <div class="quiz-progress-fill" id="quiz-progress-fill"></div>
            </div>

            <div class="quiz-progress-text">
                <span id="quiz-question-index">1</span> /
                <span id="quiz-question-total">{{ quiz_data|length }}</span>
            </div>
        </div>
    </div>

    <!-- QUIZ CARD -->
    <div class="quiz-card-modern" id="quiz-card">

        <div class="quiz-question-label">Översätt ordet</div>
        <div class="quiz-question-text" id="quiz-question-text"></div>

        <form id="quiz-form" autocomplete="off">
            <input
                type="text"
                id="quiz-answer-input"
                class="quiz-input"
                placeholder="Skriv ditt svar här..."
            >
            <button type="submit" class="quiz-submit-btn">
                Nästa
            </button>
        </form>

        <div class="quiz-feedback" id="quiz-feedback"></div>

    </div>

    <!-- RESULT -->
    <div id="quiz-summary" class="quiz-summary" style="display:none;"></div>

</div>
{% endblock %}

{% block scripts %}
<script>
const QUIZ_DATA = {{ quiz_data | tojson | safe }};
</script>

<script>
(function () {

    const data = QUIZ_DATA || [];
    if (!data.length) return;

    let index = 0;
    let correct = 0;
    const total = data.length;
    const answersLog = [];

    const qText   = document.getElementById("quiz-question-text");
    const qIndex  = document.getElementById("quiz-question-index");
    const fill    = document.getElementById("quiz-progress-fill");
    const input   = document.getElementById("quiz-answer-input");
    const form    = document.getElementById("quiz-form");
    const feedback= document.getElementById("quiz-feedback");
    const card    = document.getElementById("quiz-card");
    const summary = document.getElementById("quiz-summary");

    function clean(s) {
        return (s || "").toLowerCase().replace(/[!?.,]/g, "").trim();
    }

    function updateProgress() {
        qIndex.textContent = index + 1;
        fill.style.width = ((index + 1) / total) * 100 + "%";
    }

    function render() {
        const item = data[index];
        qText.textContent = item.question;

        input.value = "";
        input.focus();

        feedback.textContent = "";
        feedback.className = "quiz-feedback";
        card.classList.remove("quiz-card-correct", "quiz-card-wrong");

        updateProgress();
    }

    function finish() {

        const body = new URLSearchParams();
        body.append("correct", correct);
        body.append("total", total);
        body.append("answers", JSON.stringify(answersLog));

        fetch("{{ url_for('quiz.quiz_finish') }}", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body
        })
        .then(r => r.json())
        .then(res => {

            card.style.display = "none";
            summary.style.display = "block";

            summary.innerHTML = `
                <h2 class="result-title">Bra jobbat!</h2>
                <p class="result-score">
                    Du fick <strong>${res.correct}</strong> av
                    <strong>${res.total}</strong> rätt
                </p>

                <a href="{{ url_for('dashboard.home') }}" class="result-btn-home">
                    Till dashboard
                </a>
            `;
        });
    }

    form.addEventListener("submit", e => {
        e.preventDefault();

        const item = data[index];
        const raw = input.value;
        const ok = item.answers.some(a => clean(a) === clean(raw));

        answersLog.push({
            id: item.id,
            correct: ok,
            user_answer: raw
        });

        if (ok) {
            correct++;
            feedback.textContent = "Rätt!";
            feedback.classList.add("quiz-feedback-correct");
            card.classList.add("quiz-card-correct");
        } else {
            feedback.textContent = "Fel";
            feedback.classList.add("quiz-feedback-wrong");
            card.classList.add("quiz-card-wrong");
        }

        setTimeout(() => {
            index++;
            if (index >= total) finish();
            else render();
        }, 500);
    });

    render();

})();
</script>
{% endblock %}
